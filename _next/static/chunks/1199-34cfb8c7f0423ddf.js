"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1199],{79389:function(e,o,t){t.d(o,{m:function(){return S}});var r=t(77646),a=t(33125),i=t(64532),n=t.n(i),s=t(8195),l=t(43324),d=t(92293),p=t(5540),c=t(47984),u=t(27294),m=t(93311),P=t(72050),g=t(86495),h=t(12791),v=t(31611),C=t(27539),O=t(46906);class S{constructor(){this.http=n(),this.apiHelper=c.sM,this.CLOUD_FUNCTION_URL=m.q.functions.FASITY_FUNCTION,this.promoState={requestInProgress:!1,promoCodeApplied:!1,showPromoCodes:!1,promoCode:"",promoCodeHeader:"",errorMessage:"",promoCodeDescription:"",availablePromoCodes:[]},this.couponInput={header:"Coupon code",id:"PROMO",isRequired:!1,type:"TEXT",value:""},this.promoUtility=new v.R,this.eventService=new O.P,this.observe()}observe(){l.ZP.subscribe((()=>{const e=Object.assign({},l.ZP.getState().promoState),o=Object.assign({},l.ZP.getState().cartState);o&&(this.cartState=o),e.couponInput&&(this.couponInput=Object.assign({},e.couponInput)),e.promoState&&(this.promoState=Object.assign({},e.promoState)),e.isLoginRequiredForCoupon&&(this.isLoginRequiredForCoupon=e.isLoginRequiredForCoupon)}))}update(e){Object.keys(this).forEach((o=>{e.hasOwnProperty(o)&&(this[o]=Object.assign(Object.assign({},this[o]),e[o]))}))}getCatalogNameFromId(e){const o=(new s.N).findCatalog({id:e});return null===o||void 0===o?void 0:o.name}fetchApplicablePromos(e){var o;const t=null===(o=l.ZP.getState().storeState.snapshotStore)||void 0===o?void 0:o.meta,r=Object.assign({},l.ZP.getState().cartState),a=JSON.parse(JSON.stringify(null===t||void 0===t?void 0:t.paymentInformation));return e.filter((e=>{const o=!e.paymentModes.online&&!e.paymentModes.cod&&!e.paymentModes.manual;return!!(null===r||void 0===r?void 0:r.uiCart.items.find((t=>!1===t.offlineEnabled?(e.paymentModes.online||o)&&a.onlineEnabled:(e.paymentModes.online||o)&&a.onlineEnabled||(e.paymentModes.cod||o)&&a.codEnabled||(e.paymentModes.manual||o)&&a.manualEnabled)))}))}calcEffectivePromoSubTotal(e){const o=Object.assign({},l.ZP.getState().cartState);if(e.entities){const t=this.getPromoApplicableCartItems(e);return(null===t||void 0===t?void 0:t.length)?e.validOn===r.PROMO_CODE_VALID_TYPE.COLLECTIONS||e.validOn===r.PROMO_CODE_VALID_TYPE.PRODUCTS?this.promoUtility.getPromoEntitySubtotalInCart(e):null===o||void 0===o?void 0:o.uiCart.subTotal:0}return null===o||void 0===o?void 0:o.uiCart.subTotal}getPromoApplicableCartItems(e){var o,t;const r=Object.assign({},l.ZP.getState().cartState),a=JSON.parse(JSON.stringify(null===(t=null===(o=l.ZP.getState().storeState)||void 0===o?void 0:o.snapshotStore)||void 0===t?void 0:t.meta.paymentInformation));return e.entities?null===r||void 0===r?void 0:r.uiCart.items.filter((o=>!!e.entities.find((t=>("PRODUCTS"===e.validOn&&t.itemIdx&&parseInt(t.itemIdx,10)===o.productId||"COLLECTIONS"===e.validOn&&parseInt(t.catalogIdx,10)===o.catalogId)&&this.checkIsPromoPaymentApplicable(a,o,e))))):"ALL"===e.validOn?null===r||void 0===r?void 0:r.uiCart.items:[]}checkIsPromoPaymentApplicable(e,o,t){const r=!t.paymentModes.online&&!t.paymentModes.cod&&!t.paymentModes.manual;return o.offlineEnabled?(t.paymentModes.online||r)&&e.onlineEnabled||(t.paymentModes.cod||r)&&e.codEnabled||(t.paymentModes.manual||r)&&e.manualEnabled:(t.paymentModes.online||r)&&e.onlineEnabled}async applyPromo(e){var o,t,r,i;const n=Object.assign({},l.ZP.getState().promoState),s=Object.assign({},n.promoState),d=Object.assign({},n.couponInput),c=null===(o=l.ZP.getState().storeState)||void 0===o?void 0:o.snapshotStore,m=l.ZP.getState().customerState;if(this.eventService.recordEvent("apply_coupon_code","coupon_code",`applied coupon code ${s.promoCode} to cart`),!(null===(t=null===s||void 0===s?void 0:s.promoCode)||void 0===t?void 0:t.length))return;s.requestInProgress=!0;const P=a.fX.getInstance();let g=null===(i=null===(r=l.ZP.getState().customerState)||void 0===r?void 0:r.customer)||void 0===i?void 0:i.id;if(!g&&m.isLoggedIn){const e=await h.i.fetchIdToken();g=(await P.fetchCustomer(c.meta.id,e)).id}const v=await this.applyPromoCode(c,g,e,s.promoCode);if(!v)return s.errorMessage=void 0,d.errorMessage=null,l.ZP.dispatch(p.OQ.updatePromoState({errorMessage:void 0})),void l.ZP.dispatch(p.OQ.updateCouponInput(d));v.error?(d.value=s.promoCode,s.errorMessage=v.error,d.errorMessage=v.error,s.promoCodeApplied=!1,l.ZP.dispatch(p.OQ.updatePromoState({errorMessage:s.errorMessage,promoCodeApplied:s.promoCodeApplied,requestInProgress:!1})),l.ZP.dispatch(p.OQ.updateCouponInput(d)),l.ZP.dispatch(u.W2.emptyPromoData({}))):(s.errorMessage=void 0,d.errorMessage=null,s.promoCodeHeader=s.promoCode,s.promoCodeDescription=v.response,s.promoCodeApplied=!0,d.value=s.promoCode,l.ZP.dispatch(p.OQ.updatePromoState({errorMessage:void 0,promoCodeHeader:s.promoCode,promoCodeDescription:v.response,promoCodeApplied:!0})),l.ZP.dispatch(p.OQ.updateCouponInput(d)))}cancelPromo(){u.W2.updatePromoState({discount:{promoAppliedAt:void 0,promo:void 0}}),this.resetPromoState()}resetPromoState(){this.promoState.promoCodeApplied=!1,this.promoState.showPromoCodes=!1,this.promoState.promoCodeHeader="",this.promoState.promoCodeDescription="",this.promoState.promoCode="",this.promoState.errorMessage=void 0,l.ZP.dispatch(p.OQ.resetPromoState())}async fetchPromoCodes(e){var o;const t={"Content-Type":"application/json"},r=m.q.functions.FASITY_FUNCTION+"/promosFunction-getPromoCodes",a={storeId:e,promoCode:""};try{const e=await c.sM.sendData({apiPath:r,requestBody:a,requestHeader:t});if(e.data){const t=JSON.parse(JSON.stringify(e.data));if(t.promoCodes&&(this.promoState.availablePromoCodes=t.promoCodes),null===(o=this.promoState.availablePromoCodes)||void 0===o?void 0:o.length)return this.promoState.availablePromoCodes}}catch(i){return[]}return[]}async applyPromoCode(e,o,t,a){console.log("discount page "," inside apply promo ",a);const i=Object.assign({},t);if(!a)return this.apiHelper.error("Please enter promo code");const n=await this.fetchPromoCode(e.meta.id,o,a),s=l.ZP.getState().customerState.isLoggedIn;if(console.log("discount page ... ",n),n.error)return"Please login first in your account"!==n.error||s?this.apiHelper.error(n.error):(this.promoState.isLoginRequiredForCoupon=!0,void d.u.login({}).subscribe((e=>{e&&(this.promoState.requestInProgress=!1,l.ZP.dispatch(p.OQ.updatePromoState(this.promoState)))})));const c=n.data;if(c){if(i.promo=c,l.ZP.dispatch(u.W2.updatePromoState({discount:{promoAppliedAt:P.ED.currentTimeMills(),promo:c}})),console.log("discount page  ",i.subTotal,c),c.validOn===r.PROMO_CODE_VALID_TYPE.COLLECTIONS||c.validOn===r.PROMO_CODE_VALID_TYPE.PRODUCTS){const o=this.promoUtility.getPromoEntitySubtotalInCart(c);if(o&&o<c.base){if(c.validOn===r.PROMO_CODE_VALID_TYPE.COLLECTIONS)return this.apiHelper.error(`Add ${(0,C.jK)(e.meta.currency,"wide")}${c.base-o} from ${this.promoUtility.getPromoCollectionsText(c.entities)} to unlock this coupon.`);if(c.validOn===r.PROMO_CODE_VALID_TYPE.PRODUCTS)return this.apiHelper.error("Not applicable on selected product(s)")}}if(i.subTotal&&i.subTotal<c.base&&"ALL"===c.validOn)return console.log("discount page  ","returning early"),this.apiHelper.error("Minimum cart value for this promo code is "+c.base);if(c.isReferral&&0===c.base){const e="Referral code has been applied";return S.appliedPromoCode=a,S.appliedPromoDescription=e,this.apiHelper.success(e)}{console.log("discount page "," inside apply promo 2 ",c);const o=this.calcEffectivePromoSubTotal(c);if(o&&o<c.base)return this.apiHelper.error("Add more items to apply this promo code");if(!o)return this.apiHelper.error("Coupon code is not applicable");const t=l.ZP.getState().customerState;if(new g.f(e,t).applyDiscount(i),console.log("post applying discount in promo service ",i.discount),!i.discount)return this.promoState.promoCode=a,l.ZP.dispatch(p.OQ.updatePromoState(this.promoState)),this.apiHelper.error("Coupon code is not applicable");const r=`You sav2ed ${i.discount} ${e.meta.currency} \ud83c\udf89`;return S.appliedPromoCode=a,S.appliedPromoDescription=r,this.apiHelper.success(r)}}}async fetchPromoCode(e,o,t){var r;const a=null===(r=this.promoState.availablePromoCodes)||void 0===r?void 0:r.find((e=>e.code===t));return a&&!a.applyOnce?this.apiHelper.success(a):await this.fetchFromDatabase(e,o,t)}async fetchFromDatabase(e,o,t){const a=this.CLOUD_FUNCTION_URL+"/promosFunction-promoVerify",i={storeId:e,promoCode:t,customerId:o||""},n=(await c.sM.sendData({apiPath:a,requestHeader:{"Content-Type":"application/json"},requestBody:i})).data;if(null===n||void 0===n?void 0:n.error){if(l.ZP.dispatch(u.W2.emptyPromoData({})),"invalid"===n.error)return this.apiHelper.error("Coupon code is invalid");if("login_compulsory"===n.error)return this.apiHelper.error("Please login first in your account");if("promo_code_used"===n.error)return this.apiHelper.error("Coupon code already used");if("referrals-already_participated_in_referral_program"===n.error)return this.apiHelper.error("Already participated in referral program");if("referrals-promo_code_used"===n.error)return this.apiHelper.error("Referral code already used")}const s=new r.Promo;return s.load(null===n||void 0===n?void 0:n.promoJson),this.apiHelper.success(s)}async getItemPromos(e,o,t=!1){var r,a,i;return(null===(r=this.promoState.availablePromoCodes)||void 0===r?void 0:r.length)||await this.fetchPromoCodes(null===(a=l.ZP.getState().storeState.store)||void 0===a?void 0:a.meta.id),null===(i=this.promoState.availablePromoCodes)||void 0===i?void 0:i.filter((r=>this.checkIsPromoApplicableOnItem(e,r,o,t)))}checkIsPromoApplicableOnItem(e,o,t,r=!1){var a;const i=null===(a=l.ZP.getState().storeState.store)||void 0===a?void 0:a.meta.paymentInformation,n=!!r||this.checkIsPromoPaymentApplicable(i,e,o);return"COLLECTIONS"===o.validOn?!!o.entities.find((e=>{var o;return(null===(o=e.catalogIdx)||void 0===o?void 0:o.toString())===t&&n})):"PRODUCTS"===o.validOn?!!o.entities.find((o=>{var r,a;return(null===(r=o.catalogIdx)||void 0===r?void 0:r.toString())===t&&(null===(a=o.itemIdx)||void 0===a?void 0:a.toString())===e.idx&&n})):n}getPromoCollectionsText(e){let o="'";return e.forEach(((t,r)=>{const a=this.getCatalogNameFromId(t.catalogIdx);1===e.length?o+=a:r===e.length-1?o+=`and ${a}`:r===e.length-2?o+=`${a} `:o+=`${a}, `})),1===e.length?o+=" collection'":o+=" collections'",o}}},31611:function(e,o,t){t.d(o,{R:function(){return n}});var r=t(27539),a=t(77646),i=t(79389);class n{constructor(){this.sortByAvailability=(e,o)=>e.isPromoLocked===o.isPromoLocked?0:e.isPromoLocked?1:-1,this.sortByCost=(e,o)=>e.isPromoLocked&&o.isPromoLocked?e.originalPromo.base-e.subTotal-(o.originalPromo.base-o.subTotal):0}getPromoText(e,o){let t="";return t+="PERCENTAGE"===e.type?`Save ${e.value}%`:`Get flat ${(0,r.jK)(o,"wide")}${e.value} OFF`,t+=e.maxValue&&e.maxValue>0?` upto ${(0,r.jK)(o,"wide")}${e.maxValue}`:"","COLLECTIONS"===e.validOn?t+=e.base&&e.base>0?` on all orders above ${(0,r.jK)(o,"wide")}${e.base} from the\n          ${this.getPromoCollectionsText(e.entities)}`:` on all orders from the ${this.getPromoCollectionsText(e.entities)}`:"PRODUCTS"===e.validOn?t+=e.base&&e.base>0?` on orders above ${(0,r.jK)(o,"wide")}${e.base}`:" on orders":t+=e.base&&e.base>0?` on all orders above ${(0,r.jK)(o,"wide")}${e.base}`:" on all orders",t}getPromoCollectionsText(e){const o=new i.m;let t="'";return e.forEach(((r,a)=>{const i=o.getCatalogNameFromId(r.catalogIdx);i&&(1===e.length?t+=i:a===e.length-1?t+=`and ${i}`:a===e.length-2?t+=`${i} `:t+=`${i}, `)})),1===e.length?t+=" collection'":t+=" collections'",t}getFormattedUiPromoCode(e,o,t,n,s,l,d){var p;const c=new i.m,u=d?s:c.calcEffectivePromoSubTotal(e),m={promoCode:e.code,promoText:"",originalPromo:e,subTotal:u,isPromoLocked:e.base>u,promoUnlockText:""};if(m.promoText=this.getPromoText(e,null!==(p=o.currency)&&void 0!==p?p:""),l){const o=this.getPromoDiscount(e,s);m.promoDiscount=o}if(m.isPromoLocked){const i=e.base-m.subTotal,n=i%1?i.toFixed(2):i;m.promoUnlockText+=0===u?"Coupon code not applicable for items in your cart":e.validOn===a.PROMO_CODE_VALID_TYPE.COLLECTIONS?`Add ${(0,r.jK)(o.currency,"wide")}${e.base-u} from ${this.getPromoCollectionsText(e.entities)} to unlock this coupon.`:e.validOn===a.PROMO_CODE_VALID_TYPE.PRODUCTS?`Applicable on orders above ${(0,r.jK)(o.currency,"wide")}${e.base} on selected product(s)`:`Shop for ${t("string"===typeof n?parseInt(n):n)}  more to unlock this coupon`}return m}getUnlockedPromo(e,o){return o.filter((e=>!e.isPromoLocked))}getLockedPromo(e){return e.filter((e=>e.isPromoLocked))}getPromoDiscount(e,o){const t=e.type,r=e.value;let a=0;return"PERCENTAGE"===t?(o&&(a=r*o/100),e.restriction&&(a=Math.min(e.restriction,a)),a&&e.maxValue&&(a=Math.min(a,e.maxValue))):"FIXED"===t&&(a=o&&o<r?o:r),a}getPromoBannerText(e,o){let t="";return t+="PERCENTAGE"===e.type?`Save ${e.value}%`:`Get flat ${(0,r.jK)(o,"wide")}${e.value} OFF`,t+=e.maxValue&&e.maxValue>0?` upto ${(0,r.jK)(o,"wide")}${e.maxValue}`:"","COLLECTIONS"===e.validOn?t+=` on ${this.getBannerPromoCollectionsText(e.entities)}`:"PRODUCTS"===e.validOn?t+=" on selected products":"ALL"===e.validOn&&(t+=" on all orders"),t}getBannerPromoCollectionsText(e){const o=new i.m;let t="";return e.length<=2?e.forEach(((r,a)=>{const i=o.getCatalogNameFromId(r.catalogIdx);i&&(1===e.length?t+=i:a===e.length-1&&e.length>1?t+=` and ${i}`:e.length>1&&(t+=i))})):t+="select collections",t}getPromoEntitySubtotalInCart(e){const o=new i.m;let t=0;return o.getPromoApplicableCartItems(e).map((e=>{t+=e.price*e.quantity})),t}}},72050:function(e,o,t){t.d(o,{ED:function(){return r},i$:function(){return a},Rn:function(){return i},Hl:function(){return s}});class r{static currentTimeMills(){return(new Date).getTime()}}const a=e=>{const o=new Date(e),t=o.getFullYear(),r=o.getMonth(),a=n(r);return`${o.getDate()} ${a} ${t}`},i=e=>{const o=new Date(e),t=o.getHours(),r=String(o.getMinutes()).padStart(2,"0");return t<=12?`${t}:${r} AM`:`${t%12}:${r} PM`},n=e=>0===e?"Jan":1===e?"Feb":2===e?"Mar":3===e?"Apr":4===e?"May":5===e?"Jun":6===e?"July":7===e?"Aug":8===e?"Sep":9===e?"Oct":10===e?"Nov":11===e?"Dec":"",s=e=>1e3*e._seconds}}]);